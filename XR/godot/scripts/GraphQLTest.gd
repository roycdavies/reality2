extends Node

@export var GQL: Node

# ------------------------------------------------------------------------------------------------------------------------------------------------------
# Scripts used
# ------------------------------------------------------------------------------------------------------------------------------------------------------
var FSM = preload("res://scripts/FSM.gd")
var _events = FSM.Automation.new(false)
# ------------------------------------------------------------------------------------------------------------------------------------------------------



# ------------------------------------------------------------------------------------------------------------------------------------------------------
# Private Variables
# ------------------------------------------------------------------------------------------------------------------------------------------------------
var url = "https://localhost:4001/reality2"
var ws_url = "wss://localhost:4001/reality2/websocket"
var lightSwitchID = ""
# ------------------------------------------------------------------------------------------------------------------------------------------------------



# ------------------------------------------------------------------------------------------------------------------------------------------------------
# Generic Printout function
# ------------------------------------------------------------------------------------------------------------------------------------------------------
var print_result = func(data):
	print(data)
# ------------------------------------------------------------------------------------------------------------------------------------------------------



# ------------------------------------------------------------------------------------------------------------------------------------------------------
# Get a list of all the Sentants
# ------------------------------------------------------------------------------------------------------------------------------------------------------
func sentantAll(callback, details: String = "id"):
	var body = 'query {  sentantAll { ' + details + ' } }'
	GQL.query(url, body, callback)
# ------------------------------------------------------------------------------------------------------------------------------------------------------
func sentantAll_response(data):
	var response = {}
	var errors = {}
	if (data.has("errors")):
		errors = data["errors"]
		print("ERROR: ", errors)
	else:
		response = data["data"]["sentantAll"]
		print ("RESPONSE: ", response)
# ------------------------------------------------------------------------------------------------------------------------------------------------------


# ------------------------------------------------------------------------------------------------------------------------------------------------------
# Get Sentant details by ID
# ------------------------------------------------------------------------------------------------------------------------------------------------------
func sentantGetByID(callback, id: String, details: String = "id"):
	var query = 'query SentantGet($id: UUID4!) { sentantGet(id: $id) {' + details + '} }'
	var variables = {"id": id}
	GQL.query(url, query, callback, variables)
# ------------------------------------------------------------------------------------------------------------------------------------------------------
func sentantGetByID_response(data):
	var response = {}
	var errors = {}
	if (data.has("errors")):
		errors = data["errors"]
		print("ERROR: ", errors)
	else:
		response = data["data"]["sentantGet"]
		print ("RESPONSE: ", response)
# ------------------------------------------------------------------------------------------------------------------------------------------------------



# ------------------------------------------------------------------------------------------------------------------------------------------------------
# Get Sentant details by Name
# ------------------------------------------------------------------------------------------------------------------------------------------------------
func sentantGetByName(callback, name: String, details: String = "id"):
	var query = 'query SentantGet($name: String!) { sentantGet(name: $name) {' + details + '} }'
	var variables = {"name": name}
	GQL.query(url, query, callback, variables)
# ------------------------------------------------------------------------------------------------------------------------------------------------------
func sentantGetByName_response(data):
	var response = {}
	var errors = {}
	if (data.has("errors")):
		errors = data["errors"]
		print("ERROR: ", errors)
	else:
		response = data["data"]["sentantGet"]
		lightSwitchID = response["id"]
		print ("RESPONSE: ", response)
# ------------------------------------------------------------------------------------------------------------------------------------------------------



# ------------------------------------------------------------------------------------------------------------------------------------------------------
# Send an Event to a named Sentant
# ------------------------------------------------------------------------------------------------------------------------------------------------------
func sentantSend(callback, id: String, event: String, details: String = "id"):
	var query = 'mutation SentantSend($id: UUID4!, $event: String!) { sentantSend(id: $id, event: $event) {' + details + '} }'
	var variables = {"id": id, "event": event}
	GQL.query(url, query, callback, variables)
# ------------------------------------------------------------------------------------------------------------------------------------------------------
func sentantSend_response(data):
	var response = {}
	var errors = {}
	if (data.has("errors")):
		errors = data["errors"]
		print("ERROR: ", errors)
	else:
		response = data["data"]["sentantSend"]
		print ("RESPONSE: ", response)
# ------------------------------------------------------------------------------------------------------------------------------------------------------



# ------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------
func sentantEvent(callback, id: String, event: String, details: String = "id"):
	var query = 'subscription { sentantEvent(id: \"' + id + '\", event: \"' + event + '\") {' + details + '} }'
	GQL.subscription(ws_url, query, callback, {})
# ------------------------------------------------------------------------------------------------------------------------------------------------------



# ------------------------------------------------------------------------------------------------------------------------------------------------------
# Called when the node enters the scene tree for the first time.
# ------------------------------------------------------------------------------------------------------------------------------------------------------
func _ready():
	_events.add_transition("start",				"init",					"ready", 			[func(__): _events.enqueue("go", {}, 5)])
	_events.add_transition("ready",				"go",					"ready", 			[do_stuff])
# ------------------------------------------------------------------------------------------------------------------------------------------------------



# ------------------------------------------------------------------------------------------------------------------------------------------------------
# Poll the
# ------------------------------------------------------------------------------------------------------------------------------------------------------
func _process(_delta):
	_events.step()
# ------------------------------------------------------------------------------------------------------------------------------------------------------



# ------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------
var do_stuff = func(_parameters):
	sentantAll(func(data): sentantAll_response(data), "description id name")
	sentantGetByName(func(data): sentantGetByName_response(data), "Light Switch", "id")
	sentantGetByID(func(data): sentantGetByID_response(data), lightSwitchID, "name")
	
	#sentantEvent(func(data): print(data), lightSwitchID, "turn_off")
	sentantSend(func(data): sentantSend_response(data), lightSwitchID, "turn_on", "name")
# ------------------------------------------------------------------------------------------------------------------------------------------------------


func _on_subscribe_pressed():
	sentantEvent(func(data): print(data), lightSwitchID, "turn_off")
